# Full-Sync 需求文档

## 概述

Full-Sync（完整同步）是 SimTradeData 数据同步系统的核心功能，负责从多个数据源全量同步股票的市场数据、财务数据、估值数据等所有信息。它是数据系统的基础，确保本地数据库拥有完整、准确、最新的金融数据，为量化回测和策略研究提供可靠的数据支持。

## 与产品愿景的对齐

Full-Sync 直接支持 SimTradeData 的核心产品目标：

1. **零冗余数据架构**：Full-Sync 按照 11 个专用表的设计精确存储数据，避免任何冗余
2. **智能数据源融合**：自动从 Mootdx、BaoStock、QStock 三个数据源获取数据，支持故障转移
3. **完整数据同步系统**：提供增量更新、缺口检测、断点续传等企业级功能
4. **实时数据质量监控**：在同步过程中实时验证数据质量，确保数据可靠性
5. **高性能同步**：批量导入优化，支持 500+ 条/秒的同步速度

## 核心需求

### 需求 1: 基础数据更新

**用户故事**：作为数据管理员，我希望系统能自动更新交易日历和股票列表，以便获取最新的市场基础信息

#### 验证标准

1. WHEN 执行 full-sync THEN 系统 SHALL 首先更新交易日历数据
   - 获取目标日期前后 1 年的交易日历
   - 使用增量更新策略，只添加缺失的年份
   - 验证日期范围的完整性

2. WHEN 更新交易日历完成 THEN 系统 SHALL 更新股票列表
   - 获取目标日期的所有活跃股票
   - 过滤指数代码（上证 000001-000999.SS，深证 399001-399999.SZ）
   - 为新股票获取详细信息（行业、股本、上市日期）

3. IF 今日已更新且股票数量 > 3000 THEN 系统 SHALL 跳过更新以提高性能
   - 避免重复更新
   - 记录跳过原因和股票数量

### 需求 2: 增量同步市场数据

**用户故事**：作为量化研究员，我希望系统能增量同步所有股票的市场数据（OHLCV），以便获取最新的价格和成交量信息

#### 验证标准

1. WHEN 基础数据更新完成 THEN 系统 SHALL 执行增量同步
   - 获取所有活跃股票列表
   - 对每只股票执行增量更新
   - 显示实时进度条

2. WHEN 同步单只股票 THEN 系统 SHALL 使用数据预处理引擎
   - 自动选择最优数据源（Mootdx 优先）
   - 数据验证和清洗
   - 标准化存储到 market_data 表

3. IF 股票数据获取失败 THEN 系统 SHALL 记录错误并继续处理其他股票
   - 不中断整体同步流程
   - 记录失败原因和股票代码
   - 在结果中统计成功和失败数量

### 需求 3: 扩展数据同步（智能断点续传）

**用户故事**：作为数据管理员，我希望系统能智能地同步财务和估值数据，并支持断点续传，以便在同步中断后能快速恢复

#### 验证标准

1. WHEN 开始扩展数据同步 THEN 系统 SHALL 检查断点续传条件
   - 查询 extended_sync_status 表的完成记录
   - 识别已完成和待处理的股票
   - 计算完成进度并显示

2. IF 所有扩展数据已完成 THEN 系统 SHALL 跳过整个同步流程
   - 直接返回成功结果
   - 标记所有阶段为 completed

3. IF 部分股票已完成 THEN 系统 SHALL 只处理未完成的股票
   - 跳过基础数据更新和增量同步阶段
   - 直接进入扩展数据同步
   - 使用剩余股票数量作为进度条基准

4. WHEN 同步单只股票的扩展数据 THEN 系统 SHALL 使用事务保护
   - 标记 processing 状态
   - 获取财务数据（去年年报）
   - 获取估值数据（目标日期前后 10 天范围）
   - 根据数据获取结果更新状态（completed/partial/failed）

### 需求 4: 批量导入优化

**用户故事**：作为系统运维人员，我希望在处理大量股票时能使用批量导入模式，以便大幅提升同步性能

#### 验证标准

1. WHEN 待处理股票数 >= 50 OR 数据库总股票数 >= 500 THEN 系统 SHALL 启用批量模式
   - 使用 mootdx 批量导入财务数据
   - 一次性获取所有股票的年报数据
   - 构建 symbol -> data 映射表

2. WHEN 批量导入成功 THEN 系统 SHALL 使用预加载数据
   - 逐个处理股票时优先使用预加载数据
   - 跳过单独的数据源查询
   - 标记数据来源为 mootdx_batch

3. IF 批量导入失败 THEN 系统 SHALL 回退到逐个查询模式
   - 记录回退原因
   - 对每只股票单独调用数据源 API
   - 不影响整体同步流程

### 需求 5: 智能数据完整性检查

**用户故事**：作为数据管理员，我希望系统能智能检查数据完整性并自动修复状态不一致，以便确保断点续传的准确性

#### 验证标准

1. WHEN 检查扩展数据完整性 THEN 系统 SHALL 使用灵活的日期范围
   - 财务数据：检查最近 2 年的年报（去年、前年作为备用）
   - 估值数据：检查目标日期前后 10 天范围
   - 同步状态：检查 extended_sync_status 表的 completed 记录

2. WHEN 发现状态不一致 THEN 系统 SHALL 自动修复
   - 比对实际数据和同步状态记录
   - 修复 completed 但无数据的记录
   - 更新状态为 partial 或 pending

3. WHEN 清理过期状态 THEN 系统 SHALL 删除超过 1 天的 pending 记录
   - 避免僵尸状态影响判断
   - 允许重新处理

### 需求 6: 缺口检测与自动修复

**用户故事**：作为量化研究员，我希望系统能自动检测和修复历史数据缺口，以便确保回测数据的连续性

#### 验证标准

1. WHEN 扩展数据同步完成 THEN 系统 SHALL 执行缺口检测
   - 检测最近 30 天的市场数据缺口
   - 对所有活跃股票和频率进行检测
   - 统计缺口数量和分布

2. IF enable_auto_gap_fix=True AND 检测到缺口 THEN 系统 SHALL 自动修复
   - 优先修复重要股票的缺口
   - 限制最大修复数量（默认 10 个）
   - 验证缺口是否在上市日期之后

3. WHEN 修复单个缺口 THEN 系统 SHALL 使用数据预处理引擎
   - 获取缺口期间的市场数据
   - 验证并插入数据库
   - 记录修复结果（成功/失败）

### 需求 7: 数据验证

**用户故事**：作为数据质量管理员，我希望系统能在同步后验证数据质量，以便及时发现和处理数据异常

#### 验证标准

1. IF enable_validation=True THEN 系统 SHALL 执行数据验证
   - 验证最近 7 天的数据
   - 检查所有活跃股票和频率
   - 显示实时进度

2. WHEN 验证数据 THEN 系统 SHALL 检查数据完整性和正确性
   - 验证记录数量
   - 检查数据有效性
   - 计算验证通过率

3. WHEN 验证完成 THEN 系统 SHALL 返回验证报告
   - 总记录数
   - 有效记录数
   - 验证率百分比
   - 异常记录详情

### 需求 8: 完整同步报告

**用户故事**：作为数据管理员，我希望系统能生成详细的同步报告，以便了解同步结果和诊断问题

#### 验证标准

1. WHEN full-sync 完成 THEN 系统 SHALL 返回完整结果
   - 目标日期和同步时间
   - 各阶段执行状态和结果
   - 总体统计摘要
   - 执行耗时

2. WHEN 任何阶段失败 THEN 系统 SHALL 记录详细错误
   - 失败阶段名称
   - 错误信息和堆栈
   - 影响范围

3. WHEN 生成同步报告 THEN 系统 SHALL 包含关键指标
   - 成功/失败阶段数
   - 处理的股票数量
   - 插入的数据记录数
   - 性能指标

## 非功能性需求

### 代码架构和模块化

- **单一职责原则**：每个方法只负责一个明确的功能
- **模块化设计**：子组件（IncrementalSync、GapDetector、DataValidator）独立且可复用
- **依赖管理**：通过构造函数注入依赖，避免硬编码
- **清晰接口**：公共方法使用 @unified_error_handler 装饰器，返回标准格式

### 性能要求

- **同步速度**：>500 条/秒（批量模式）
- **内存使用**：<2GB（处理 5000+ 股票）
- **响应时间**：进度条实时更新（<100ms 延迟）
- **并发支持**：支持多线程数据获取（数据源层面）

### 可靠性要求

- **断点续传**：支持中断后快速恢复
- **事务保护**：扩展数据同步使用事务确保原子性
- **数据验证**：自动验证数据质量
- **错误恢复**：单个股票失败不影响整体流程

### 可维护性要求

- **日志完整**：每个阶段记录详细日志（INFO/DEBUG/WARNING/ERROR）
- **进度可视**：使用分阶段进度条显示实时进度
- **配置灵活**：支持通过配置文件控制行为
- **代码清晰**：遵循 SimTradeData 数据同步规范

### 可扩展性要求

- **数据源扩展**：支持新增数据源适配器
- **市场扩展**：支持港股、美股等多市场
- **频率扩展**：支持分钟级、小时级等多频率
- **指标扩展**：支持自定义技术指标计算
